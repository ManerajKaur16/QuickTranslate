<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="refresh" content="0; url=text-translator.html">
  <title>Quick Translate - Login</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <link rel="stylesheet" href="style.css" />

  <!-- Theme Setup -->
  <script>
    (function () {
      const saved = JSON.parse(localStorage.getItem("settings")) || {};
      const theme = saved.theme || "light";
      document.addEventListener("DOMContentLoaded", () => {
        document.body.classList.add(`${theme}-theme`);
      });
    })();
  </script>

  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB1bdyCh87pa1nQk_te72zrZLxrqlQvB-o",
      authDomain: "smartlibrarymanagementsy-13082.firebaseapp.com",
      databaseURL: "https://smartlibrarymanagementsy-13082-default-rtdb.firebaseio.com",
      projectId: "smartlibrarymanagementsy-13082",
      storageBucket: "smartlibrarymanagementsy-13082.appspot.com",
      messagingSenderId: "128388067166",
      appId: "1:128388067166:web:02bf2c483c53342912b96f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <style>
    .password-container {
      position: relative;
    }

    .password-container input {
      width: 100%;
      padding-right: 40px;
    }

    .toggle-password {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="login-container">
    <img src="assets/logo.png" alt="App Logo" class="logo" />
    <h2 class="welcome">Welcome To Quick Translate</h2>

    <form onsubmit="event.preventDefault(); login();">
      <input type="text" id="login-phone" placeholder="+ Country Code Phone Number" required />

    <div class="password-container">
    <input type="password" id="login-password" placeholder="Password" required />
    <button type="button" class="toggle-password" onclick="toggleVisibility('login-password', this)" title="Show password">
    <img src="assets/visibility.png" alt="Show password" class="eye-icon" />
    </button>
    </div>

      <button class="primary-btn" type="submit">LOGIN</button>
    </form>
      <p class="forgot-password">
      <a href="forgot-password.html">Forgot Password?</a>
      </p>

    <p id="status" class="status-message"></p>

    <div class="or-divider">
      <div class="line"></div>
      <span>or</span>
      <div class="line"></div>
    </div>

    <button class="social-btn google" onclick="googleLogin()">
      <img src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" width="20" height="20" alt="Google" />
      Continue with Google
    </button>

    <button class="create-account-btn" onclick="window.location.href='signup.html'">Create New Account</button>

    <p class="terms">
      By clicking continue, you agree to our
      <a href="#">Terms of Service</a> and
      <a href="#">Privacy Policy</a>
    </p>
  </div>

  <script>
    async function login() {
      const phone = document.getElementById("login-phone").value.trim();
      const password = document.getElementById("login-password").value;
      const status = document.getElementById("status");

      const phoneRegex = /^\+\d{8,15}$/;

      if (!phoneRegex.test(phone)) {
        status.innerText = "❌ Please enter a valid phone number in international format (e.g., +14155552671)";
        return;
      }

      try {
        const snapshot = await firebase.database().ref("users").once("value");
        const users = snapshot.val();
        let matched = false;

        for (let uid in users) {
          const user = users[uid];
          if (user.phone_number === phone && user.password === password) {
            matched = true;
            status.innerText = "✅ Phone login successful!";
            setTimeout(() => (window.location.href = "main.html"), 1000);
            break;
          }
        }

        if (!matched) {
          status.innerText = "❌ Invalid phone number or password.";
        }
      } catch (err) {
        console.error(err);
        status.innerText = "❌ Error retrieving user data.";
      }
    }

    function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          const now = new Date();
          const date_created = now.toLocaleDateString('en-CA');
          const time_created = now.toLocaleTimeString('en-GB');

          const userRef = db.ref("users/" + user.uid);
          userRef.once("value").then(snapshot => {
            if (!snapshot.exists()) {
              userRef.set({
                user_id: user.uid,
                email: user.email,
                phone_number: user.phoneNumber || "",
                date_created,
                time_created
              });
            }
          });

          document.getElementById("status").innerText = "✅ Logged in with Google!";
          setTimeout(() => window.location.href = "main.html", 1500);
        })
        .catch(error => {
          document.getElementById("status").innerText = "❌ " + error.message;
        });
    }

 function toggleVisibility(inputId, btn) {
  const input = document.getElementById(inputId);
  const icon = btn.querySelector("img");

  if (input.type === "password") {
    input.type = "text";
    icon.src = "assets/invisibility.png";
    icon.alt = "Hide password";
    btn.title = "Hide password";
  } else {
    input.type = "password";
    icon.src = "assets/visibility.png";
    icon.alt = "Show password";
    btn.title = "Show password";
  }
}

  </script>
</body>
</html>
