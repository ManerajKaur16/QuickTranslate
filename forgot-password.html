<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password</title>
  <link rel="stylesheet" href="reset.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB1bdyCh87pa1nQk_te72zrZLxrqlQvB-o",
      authDomain: "smartlibrarymanagementsy-13082.firebaseapp.com",
      databaseURL: "https://smartlibrarymanagementsy-13082-default-rtdb.firebaseio.com",
      projectId: "smartlibrarymanagementsy-13082",
      storageBucket: "smartlibrarymanagementsy-13082.appspot.com",
      messagingSenderId: "128388067166",
      appId: "1:128388067166:web:02bf2c483c53342912b96f"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>

<body>
  <div class="login-container">
    <div class="header-row">
      <button class="back-btn" onclick="window.location.href='index.html'">‚Üê</button>
      <h2>Reset Password</h2>
    </div>

    <input type="text" id="reset-phone" placeholder="+ Country Code Phone Number" />

    <div id="recaptcha-container"></div>

    <button class="primary-btn" onclick="sendResetOTP()">Send OTP</button>

    <input type="text" id="reset-otp" placeholder="Enter OTP" class="hidden" />
    <button class="primary-btn hidden" id="verify-btn" onclick="verifyResetOTP()">Verify OTP</button>

    <div id="new-password-section" class="hidden">
      <input type="password" id="new-password" placeholder="New Password" />
      <input type="password" id="confirm-password" placeholder="Confirm Password" />
      <button class="primary-btn" onclick="updatePassword()">Update Password</button>
    </div>

    <p id="reset-status" class="status-message"></p>
  </div>

  <script>
    let confirmationResult;
    const db = firebase.database();

    window.onload = () => {
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        size: 'normal',
        callback: () => console.log("reCAPTCHA verified")
      });
      recaptchaVerifier.render();
    };

    function sendResetOTP() {
      const phone = document.getElementById("reset-phone").value.trim();
      const status = document.getElementById("reset-status");

      if (!/^\+\d{8,15}$/.test(phone)) {
        status.innerText = "‚ùå Invalid phone number format.";
        return;
      }

      firebase.auth().signInWithPhoneNumber(phone, recaptchaVerifier)
        .then(result => {
          confirmationResult = result;
          status.innerText = "üì≤ OTP sent to your phone.";
          document.getElementById("reset-otp").classList.remove("hidden");
          document.getElementById("verify-btn").classList.remove("hidden");
        })
        .catch(err => {
          status.innerText = "‚ùå " + err.message;
        });
    }

    function verifyResetOTP() {
      const code = document.getElementById("reset-otp").value.trim();
      const status = document.getElementById("reset-status");

      if (!confirmationResult) {
        status.innerText = "‚ùå Please request OTP first.";
        return;
      }

      confirmationResult.confirm(code)
        .then(() => {
          status.innerText = "‚úÖ OTP verified. You can now set a new password.";
          document.getElementById("new-password-section").classList.remove("hidden");
        })
        .catch(() => {
          status.innerText = "‚ùå Incorrect OTP.";
        });
    }

    function updatePassword() {
      const newPass = document.getElementById("new-password").value.trim();
      const confirmPass = document.getElementById("confirm-password").value.trim();
      const phone = document.getElementById("reset-phone").value.trim();
      const status = document.getElementById("reset-status");

      if (newPass.length < 6) {
        status.innerText = "‚ùå Password must be at least 6 characters.";
        return;
      }

      if (newPass !== confirmPass) {
        status.innerText = "‚ùå Passwords do not match.";
        return;
      }

      db.ref("users").once("value", snapshot => {
        const users = snapshot.val();
        let found = false;

        for (let uid in users) {
          if (users[uid].phone_number === phone) {
            db.ref("users/" + uid).update({ password: newPass });
            status.innerText = "‚úÖ Password reset successful.";
            found = true;
            break;
          }
        }

        if (!found) {
          status.innerText = "‚ùå User not found.";
        }
      });
    }
  </script>
</body>
</html>
